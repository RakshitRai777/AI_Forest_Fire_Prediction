"""
Report generation service for forest fire prediction.
Creates professional text and HTML reports for fire risk assessments.
"""

import logging
from datetime import datetime
from typing import Dict, Any, Optional
from pathlib import Path

from models import FireRiskAssessment, RiskLevel
from config import REPORTS_DIR

logger = logging.getLogger(__name__)


class ReportGenerator:
    """Service for generating fire risk reports."""
    
    def __init__(self):
        self.reports_dir = REPORTS_DIR
        self.reports_dir.mkdir(exist_ok=True)
    
    def generate_text_report(self, assessment: FireRiskAssessment) -> str:
        """
        Generate a detailed text report for the fire risk assessment.
        
        Args:
            assessment: Fire risk assessment object
            
        Returns:
            Formatted text report
        """
        try:
            report_lines = []
            
            # Header
            report_lines.append("=" * 60)
            report_lines.append("FOREST FIRE RISK ASSESSMENT REPORT")
            report_lines.append("=" * 60)
            report_lines.append("")
            
            # Location and timestamp
            report_lines.append(f"Location: {assessment.location.city}")
            if assessment.location.state:
                report_lines.append(f"State/Province: {assessment.location.state}")
            if assessment.location.country:
                report_lines.append(f"Country: {assessment.location.country}")
            report_lines.append(f"Coordinates: {assessment.location.latitude:.4f}, {assessment.location.longitude:.4f}")
            report_lines.append(f"Assessment Date: {assessment.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC')}")
            report_lines.append("")
            
            # Risk Summary
            report_lines.append("RISK SUMMARY")
            report_lines.append("-" * 20)
            risk_emoji = self._get_risk_emoji(assessment.risk_level)
            report_lines.append(f"Risk Level: {risk_emoji} {assessment.risk_level.value.upper()}")
            report_lines.append(f"Fire Probability: {assessment.probability:.1%}")
            report_lines.append("")
            
            # Current Conditions
            report_lines.append("CURRENT CONDITIONS")
            report_lines.append("-" * 20)
            report_lines.append(f"Temperature: {assessment.weather_data.temperature:.1f}¬∞C")
            report_lines.append(f"Humidity: {assessment.weather_data.humidity:.1f}%")
            report_lines.append(f"Wind Speed: {assessment.weather_data.wind_speed:.1f} km/h")
            report_lines.append(f"Rainfall: {assessment.weather_data.rainfall:.1f} mm")
            report_lines.append("")
            
            # Environmental Conditions
            report_lines.append("ENVIRONMENTAL CONDITIONS")
            report_lines.append("-" * 30)
            report_lines.append(f"Vegetation Type: {assessment.vegetation_data.vegetation_type}")
            report_lines.append(f"NDVI (Vegetation Index): {assessment.vegetation_data.ndvi:.3f}")
            report_lines.append(f"Soil Moisture: {assessment.vegetation_data.soil_moisture:.1f}%")
            report_lines.append(f"Drought Index: {assessment.vegetation_data.drought_index:.3f}")
            report_lines.append("")
            
            # Risk Factors Analysis
            report_lines.append("RISK FACTORS ANALYSIS")
            report_lines.append("-" * 25)
            factors = assessment.factors
            report_lines.append(f"Temperature Factor: {factors.temperature_factor:.2f}")
            report_lines.append(f"Humidity Factor: {factors.humidity_factor:.2f}")
            report_lines.append(f"Wind Factor: {factors.wind_factor:.2f}")
            report_lines.append(f"Rainfall Factor: {factors.rainfall_factor:.2f}")
            report_lines.append(f"Vegetation Factor: {factors.vegetation_factor:.2f}")
            report_lines.append(f"Drought Factor: {factors.drought_factor:.2f}")
            report_lines.append("")
            
            # Recommendations
            report_lines.append("SAFETY RECOMMENDATIONS")
            report_lines.append("-" * 25)
            for i, rec in enumerate(assessment.recommendations, 1):
                report_lines.append(f"{i}. {rec}")
            report_lines.append("")
            
            # Risk Interpretation
            report_lines.append("RISK INTERPRETATION")
            report_lines.append("-" * 20)
            interpretation = self._get_risk_interpretation(assessment.risk_level)
            report_lines.append(interpretation)
            report_lines.append("")
            
            # Footer
            report_lines.append("=" * 60)
            report_lines.append("Report generated by AI Forest Fire Prediction System")
            report_lines.append(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            report_lines.append("=" * 60)
            
            return "\n".join(report_lines)
            
        except Exception as e:
            logger.error(f"Error generating text report: {str(e)}")
            return f"Error generating report: {str(e)}"
    
    def generate_html_report(self, assessment: FireRiskAssessment) -> str:
        """
        Generate an HTML report for the fire risk assessment.
        
        Args:
            assessment: Fire risk assessment object
            
        Returns:
            Formatted HTML report
        """
        try:
            risk_color = self._get_risk_color(assessment.risk_level)
            risk_emoji = self._get_risk_emoji(assessment.risk_level)
            
            html_template = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Fire Risk Assessment - {assessment.location.city}</title>
    <style>
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }}
        .container {{
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }}
        .header {{
            text-align: center;
            border-bottom: 3px solid {risk_color};
            padding-bottom: 20px;
            margin-bottom: 30px;
        }}
        .risk-level {{
            font-size: 2.5em;
            font-weight: bold;
            color: {risk_color};
            margin: 10px 0;
        }}
        .probability {{
            font-size: 1.5em;
            color: #666;
            margin: 10px 0;
        }}
        .section {{
            margin: 25px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid {risk_color};
        }}
        .section h2 {{
            margin-top: 0;
            color: #333;
        }}
        .data-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }}
        .data-item {{
            background: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }}
        .data-label {{
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
        }}
        .data-value {{
            font-size: 1.2em;
            color: #333;
            margin-top: 5px;
        }}
        .recommendations {{
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
        }}
        .recommendations ul {{
            margin: 0;
            padding-left: 20px;
        }}
        .recommendations li {{
            margin: 10px 0;
        }}
        .footer {{
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9em;
        }}
        .risk-factor {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin: 5px 0;
            border-radius: 5px;
        }}
        .factor-bar {{
            width: 100px;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-left: 10px;
        }}
        .factor-fill {{
            height: 100%;
            background: {risk_color};
            transition: width 0.3s ease;
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Forest Fire Risk Assessment</h1>
            <h2>{assessment.location.city}</h2>
            {f'<p>{assessment.location.state}, {assessment.location.country}</p>' if assessment.location.state else ''}
            <p>Coordinates: {assessment.location.latitude:.4f}, {assessment.location.longitude:.4f}</p>
            <div class="risk-level">
                {risk_emoji} {assessment.risk_level.value.upper()}
            </div>
            <div class="probability">
                Fire Probability: {assessment.probability:.1%}
            </div>
            <p>Assessment Date: {assessment.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC')}</p>
        </div>

        <div class="section">
            <h2>üå§Ô∏è Current Weather Conditions</h2>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">Temperature</div>
                    <div class="data-value">{assessment.weather_data.temperature:.1f}¬∞C</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Humidity</div>
                    <div class="data-value">{assessment.weather_data.humidity:.1f}%</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Wind Speed</div>
                    <div class="data-value">{assessment.weather_data.wind_speed:.1f} km/h</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Rainfall</div>
                    <div class="data-value">{assessment.weather_data.rainfall:.1f} mm</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üåø Environmental Conditions</h2>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">Vegetation Type</div>
                    <div class="data-value">{assessment.vegetation_data.vegetation_type}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">NDVI Index</div>
                    <div class="data-value">{assessment.vegetation_data.ndvi:.3f}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Soil Moisture</div>
                    <div class="data-value">{assessment.vegetation_data.soil_moisture:.1f}%</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Drought Index</div>
                    <div class="data-value">{assessment.vegetation_data.drought_index:.3f}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìä Risk Factors Analysis</h2>
            <div class="risk-factor">
                <span>Temperature Factor</span>
                <div class="factor-bar">
                    <div class="factor-fill" style="width: {assessment.factors.temperature_factor * 100}%"></div>
                </div>
                <span>{assessment.factors.temperature_factor:.2f}</span>
            </div>
            <div class="risk-factor">
                <span>Humidity Factor</span>
                <div class="factor-bar">
                    <div class="factor-fill" style="width: {assessment.factors.humidity_factor * 100}%"></div>
                </div>
                <span>{assessment.factors.humidity_factor:.2f}</span>
            </div>
            <div class="risk-factor">
                <span>Wind Factor</span>
                <div class="factor-bar">
                    <div class="factor-fill" style="width: {assessment.factors.wind_factor * 100}%"></div>
                </div>
                <span>{assessment.factors.wind_factor:.2f}</span>
            </div>
            <div class="risk-factor">
                <span>Rainfall Factor</span>
                <div class="factor-bar">
                    <div class="factor-fill" style="width: {assessment.factors.rainfall_factor * 100}%"></div>
                </div>
                <span>{assessment.factors.rainfall_factor:.2f}</span>
            </div>
            <div class="risk-factor">
                <span>Vegetation Factor</span>
                <div class="factor-bar">
                    <div class="factor-fill" style="width: {assessment.factors.vegetation_factor * 100}%"></div>
                </div>
                <span>{assessment.factors.vegetation_factor:.2f}</span>
            </div>
            <div class="risk-factor">
                <span>Drought Factor</span>
                <div class="factor-bar">
                    <div class="factor-fill" style="width: {assessment.factors.drought_factor * 100}%"></div>
                </div>
                <span>{assessment.factors.drought_factor:.2f}</span>
            </div>
        </div>

        <div class="section">
            <h2>‚ö†Ô∏è Safety Recommendations</h2>
            <div class="recommendations">
                <ul>
                    {''.join([f'<li>{rec}</li>' for rec in assessment.recommendations])}
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üìã Risk Interpretation</h2>
            <p>{self._get_risk_interpretation(assessment.risk_level)}</p>
        </div>

        <div class="footer">
            <p>Report generated by AI Forest Fire Prediction System</p>
            <p>Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        </div>
    </div>
</body>
</html>
            """
            
            return html_template
            
        except Exception as e:
            logger.error(f"Error generating HTML report: {str(e)}")
            return f"<html><body><h1>Error generating report: {str(e)}</h1></body></html>"
    
    def save_report(self, assessment: FireRiskAssessment, report_type: str = "text") -> Optional[str]:
        """
        Save report to file.
        
        Args:
            assessment: Fire risk assessment
            report_type: Type of report ("text" or "html")
            
        Returns:
            File path if saved successfully, None otherwise
        """
        try:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"fire_risk_report_{assessment.location.city}_{timestamp}.{report_type}"
            filepath = self.reports_dir / filename
            
            if report_type == "text":
                content = self.generate_text_report(assessment)
            elif report_type == "html":
                content = self.generate_html_report(assessment)
            else:
                raise ValueError(f"Unsupported report type: {report_type}")
            
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(content)
            
            logger.info(f"Report saved to {filepath}")
            return str(filepath)
            
        except Exception as e:
            logger.error(f"Error saving report: {str(e)}")
            return None
    
    def _get_risk_emoji(self, risk_level: RiskLevel) -> str:
        """Get emoji for risk level."""
        emoji_map = {
            RiskLevel.LOW: "‚úÖ",
            RiskLevel.MODERATE: "‚ö°",
            RiskLevel.HIGH: "‚ö†Ô∏è",
            RiskLevel.EXTREME: "üî•"
        }
        return emoji_map.get(risk_level, "‚ùì")
    
    def _get_risk_color(self, risk_level: RiskLevel) -> str:
        """Get color for risk level."""
        color_map = {
            RiskLevel.LOW: "#28a745",      # Green
            RiskLevel.MODERATE: "#ffc107",  # Yellow
            RiskLevel.HIGH: "#fd7e14",      # Orange
            RiskLevel.EXTREME: "#dc3545"    # Red
        }
        return color_map.get(risk_level, "#6c757d")
    
    def _get_risk_interpretation(self, risk_level: RiskLevel) -> str:
        """Get interpretation text for risk level."""
        interpretations = {
            RiskLevel.LOW: (
                "Low fire risk conditions are present. While the risk of fire is minimal, "
                "standard fire safety practices should always be followed. Monitor conditions "
                "as they can change throughout the day."
            ),
            RiskLevel.MODERATE: (
                "Moderate fire risk conditions exist. Some fire behavior is possible, "
                "especially in dry, windy areas. Use caution with outdoor activities and "
                "ensure proper fire suppression equipment is available."
            ),
            RiskLevel.HIGH: (
                "High fire risk conditions are present. Fires can start easily and spread "
                "rapidly. Avoid outdoor burning and be extremely careful with any potential "
                "ignition sources. Have evacuation plans ready."
            ),
            RiskLevel.EXTREME: (
                "Extreme fire danger conditions exist. This is the highest level of fire risk. "
                "Fires will start easily, spread rapidly, and be difficult to control. "
                "Evacuation may be necessary. Follow all emergency service instructions "
                "immediately."
            )
        }
        return interpretations.get(risk_level, "Risk level interpretation not available.")
    
    def get_report_summary(self, assessment: FireRiskAssessment) -> Dict[str, Any]:
        """
        Get a summary of the assessment for quick display.
        
        Args:
            assessment: Fire risk assessment
            
        Returns:
            Dictionary with summary information
        """
        return {
            "location": assessment.location.city,
            "risk_level": assessment.risk_level.value,
            "probability": f"{assessment.probability:.1%}",
            "temperature": f"{assessment.weather_data.temperature:.1f}¬∞C",
            "humidity": f"{assessment.weather_data.humidity:.1f}%",
            "wind_speed": f"{assessment.weather_data.wind_speed:.1f} km/h",
            "timestamp": assessment.timestamp.strftime("%Y-%m-%d %H:%M:%S"),
            "recommendations_count": len(assessment.recommendations),
            "primary_factors": [
                ("Temperature", assessment.factors.temperature_factor),
                ("Humidity", assessment.factors.humidity_factor),
                ("Wind", assessment.factors.wind_factor)
            ]
        }
